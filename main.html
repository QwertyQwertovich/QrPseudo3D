<!doctype html>
<html>
	<head>
		<title>by Kharitonov Alexander</title>
        <meta charset='utf-8' />
	</head>
	<body>
		<canvas height='320' width='480' id='example'>Update the browser</canvas>
		<script>
			var example = document.getElementById("example"),
			    ctx     = example.getContext('2d');
			var level =[[70,-100,70,200],[60,50,60,100],[0,70,100,70]]
			//var level =[[70,0,70,100]]
			var x = 50,y=50,a=0,fov=40,alfa=20;
			function rast(x,y,z){
				return(Math.sqrt((x-z[0])*(x-z[0])+(y-z[1])*(y-z[1])));
			};
			function lineline(x1,y1,x2,y2,x3,y3,x4,y4){
				xp = ((x1*y2-y1*x2)*(x3-x4)-(x1-x2)*(x3*y4-y3*x4))/((x1-x2)*(y3-y4)-(y1-y2)*(x3-x4));
				yp = ((x1*y2-y1*x2)*(y3-y4)-(y1-y2)*(x3*y4-y3*x4))/((x1-x2)*(y3-y4)-(y1-y2)*(x3-x4));
				if (xp>x1 && xp<x2 && yp>y1 && yp<y2){
					return [xp,yp];
				};
				return [xp,yp];
			};
			//setInterval(draw, 20);
			draw();
			//console.log(lineline(1,22,333,44,56,64,73,68));
			function draw(){
				ctx.clearRect(0,0,example.width, example.height);
			    ctx.fillStyle='green';
			    ctx.fillRect(0, 0, example.width, example.height);
			    ctx.fillStyle='red';
				dist=raycast(alfa,fov);
				console.log(dist)
				for(var i=alfa-fov;i<alfa+fov;i++){
					//console.log(alfa,example.width*(i+fov)/fov/2, example.height/2-(1/dist[i])*500, example.width/fov/2, (1/dist[i])*1000)
					ctx.fillRect(example.width*(i+fov)/fov/2, example.height/2-(1/dist[i])*500,example.width/fov/2, (1/dist[i])*1000);
				}
				alfa=alfa
			};
			function raycast(alfa,fov){
				var rays = [],dist=[]
				for (var ray=alfa-fov;ray<alfa+fov;ray++){
					rays[ray]=1000
					dist[ray]=1000
					for(var i=0;i<level.length;i++){
						var xx=x+10;
						var yy=y+10*Math.tan(ray*3.141592/180);
						//console.log(x1,y1)
						var x1=level[i][0],y1=level[i][1],x2=level[i][2],y2=level[i][3],x3=level[i][4];
						rayy = lineline(x1,y1,x2,y2,x,y,xx,yy);
						rastt = rast(x,y,rayy)
						//console.log(rayy,rastt)
						console.log(alfa,ray)
						if (dist[ray]>rastt){
							dist[ray]=rastt;
							rayy[ray]=rayy;
						};
					};
				};
				return dist
			};
			function gri(max) {
				return Math.floor(Math.random() * Math.floor(max));
			};
		</script>
		<text> by Qwerty_Qwertovich(Alexander Kharitonov)</text>
	</body>
</html>